<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Partes â€” Luciano S.A.</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>

<body>
  <!-- LOADER -->
  <div id="appLoader" class="app-loader hidden">
    <div class="spinner"></div>
    <p>Cargandoâ€¦</p>
  </div>

  <div class="layout">
    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar hidden">
      <div class="brand">
        <div class="brand-icon"><i class="fa-solid fa-gear"></i></div>
        <div>
          <div class="title">Control de Partes</div>
          <div class="subtitle">Luciano S.A.</div>
        </div>
      </div>

      <nav class="menu">
        <!-- ðŸ”¹ SIN 'active' POR DEFECTO -->
        <button class="menu-item tab-btn" data-tab="dashboard"><i class="fa-solid fa-chart-line"></i> Resumen</button>
        <button class="menu-item tab-btn" data-tab="usuarios"><i class="fa-solid fa-user-group"></i> Usuarios</button>
        <button class="menu-item tab-btn" data-tab="internos"><i class="fa-solid fa-truck-front"></i> Internos</button>
        <button class="menu-item tab-btn" data-tab="partes"><i class="fa-solid fa-clipboard-list"></i> Partes</button>
        <button class="menu-item tab-btn" data-tab="service"><i class="fa-solid fa-screwdriver-wrench"></i> Service</button>
        <button class="menu-item tab-btn" data-tab="sinpartes"><i class="fa-regular fa-clock"></i> Sin partes (â‰¥5 dÃ­as)</button>
        <!-- ===== MÃ“DULO COMBUSTIBLE ===== -->
        <button class="menu-item tab-btn" data-tab="combustible">
          <i class="fa-solid fa-gas-pump"></i> Combustible
        </button>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- TOPBAR -->
      <header class="topbar hidden" id="topbar">
        <div class="topbar-left">
          <button id="sidebarToggle" class="btn icon" title="MenÃº">
            <i class="fa-solid fa-bars"></i>
          </button>
          <h1 class="topbar-title">Panel</h1>
        </div>
        <div class="topbar-right">
          <div class="user-pill">
            <i class="fa-regular fa-circle-user"></i>
            <span id="userActive">Usuario</span>
            <button id="btnSalirAdmin" class="btn text danger"><i class="fa-solid fa-right-from-bracket"></i> Salir</button>
          </div>
        </div>
      </header>

      <!-- LOGIN -->
      <section id="login-section" class="login-screen card p-24">
        <div class="login-card">
          <div class="login-header">
            <div class="brand-icon lg"><i class="fa-solid fa-gear"></i></div>
            <h2>Control de Partes</h2>
            <p class="muted">Luciano S.A.</p>
          </div>
          <div class="field">
            <label>Usuario</label>
            <select id="usuario" class="input"></select>
          </div>
          <div class="field">
            <label>Legajo</label>
            <input id="legajo" class="input" placeholder="IngresÃ¡ tu legajo" />
          </div>
          <button id="btnLogin" class="btn primary">Ingresar</button>
          <p id="errorLogin" class="msg err"></p>
          <p id="msgNoUsers" class="msg muted hidden">No hay usuarios cargados.</p>
        </div>
      </section>

      <!-- FORMULARIO OPERARIO -->
      <section id="form-section" class="hidden">
        <div class="grid cols-2 gap-24">
          <div class="card">
            <div class="card-header">
              <h3>Parte Diario</h3>
              <button id="btnSalir" class="btn text danger"><i class="fa-solid fa-right-from-bracket"></i> Salir</button>
            </div>

            <div class="grid cols-2 gap-12">
              <div class="field">
                <label>Fecha</label>
                <input id="fecha" type="date" class="input" />
              </div>
              <div class="field">
                <label>Interno</label>
                <select id="interno" class="input"></select>
              </div>
              <div class="field col-2">
                <label>Horas / Km finales</label>
                <input id="final" class="input" placeholder="Ej: 245 (hs) o 85630 (km)" />
              </div>
              <div class="field col-2">
                <label>Â¿CargÃ³ combustible?</label>
                <select id="cargoCombustible" class="input">
                  <option value="no" selected>No</option>
                  <option value="si">SÃ­</option>
                </select>
              </div>

              <div id="datosCombustible" class="field col-1 hidden">
                <label>Litros</label>
                <input id="litros" type="number" class="input" placeholder="Ej: 120" />
              </div>
              <div id="datosCombustible2" class="field col-1 hidden">
                <label>Km desde la Ãºltima carga</label>
                <input id="kmCarga" type="number" class="input" placeholder="Ej: 340" />
              </div>

              <div class="field col-2">
                <label>Novedades</label>
                <textarea id="novedades" class="input" rows="5" placeholder="Observaciones, novedades o comentarios"></textarea>
              </div>
            </div>

            <div class="card-actions">
              <button id="btnGuardar" class="btn success">
                <i class="fa-solid fa-floppy-disk"></i> Guardar parte
              </button>
              <span id="msgGuardado" class="msg"></span>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Ãšltimo parte del interno</h3>
              <span id="estadoServiceChip" class="badge">â€”</span>
            </div>
            <div class="kv">
              <div><span>Fecha</span><strong id="uFecha">â€”</strong></div>
              <div><span>Final</span><strong id="uFinal">â€”</strong></div>
              <div><span>Combustible</span><strong id="uCombustible">â€”</strong></div>
              <div><span>Novedades</span><strong id="uNovedades">â€”</strong></div>
            </div>
            <p class="muted small">Se calcula automÃ¡ticamente por horas/km desde el Ãºltimo service.</p>
          </div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="admin-section" class="hidden">
        <div class="admin-layout">

          <!-- ====================== PANTALLA NEUTRA (INICIAL) ====================== -->
          <div id="tab-neutral" class="subtab">
            <div style="padding: 80px 20px; text-align: center; color: #64748b;">
              <h2>Bienvenido al Panel de Control</h2>
              <p>SeleccionÃ¡ una opciÃ³n del menÃº lateral para comenzar.</p>
            </div>
          </div>

          <!-- ====================== MÃ“DULO COMBUSTIBLE (v1.2.3) ====================== -->
          <div id="tab-combustible" class="subtab hidden">
            <div class="subtabs-menu">
              <button class="subtab-btn active" data-subtab="carga">Carga de combustible</button>
              <button class="subtab-btn" data-subtab="interno">Por interno</button>
              <button class="subtab-btn" data-subtab="chofer">Por chofer</button>
              <div class="flex-spacer"></div>
              <button id="btnCombustibleRefresh" class="btn tiny" title="Refrescar datos">â†» Refrescar</button>
            </div>

            <!-- Subtab: CARGA -->
            <div id="subtab-carga" class="subtab-content">
              <div class="card">
                <div class="card-header">
                  <h3>Registrar carga de combustible</h3>
                </div>

                <div class="grid cols-3 gap-12">
                  <div class="field">
                    <label>Interno</label>
                    <select id="cc-interno" class="input"></select>
                  </div>
                  <div class="field">
                    <label>Fecha</label>
                    <input id="cc-fecha" type="date" class="input" />
                  </div>
                  <div class="field">
                    <label>Chofer</label>
                    <select id="cc-chofer" class="input"></select>
                  </div>
                  <div class="field">
                    <label>Km actuales</label>
                    <input id="cc-km" type="number" class="input" placeholder="Ej: 85420" />
                  </div>
                  <div class="field">
                    <label>Litros cargados</label>
                    <input id="cc-litros" type="number" class="input" placeholder="Ej: 200" />
                  </div>
                  <div class="field">
                    <label>Tipo de carga</label>
                    <select id="cc-tipo" class="input">
                      <option value="Completa">Completa</option>
                      <option value="Parcial">Parcial</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Origen</label>
                    <select id="cc-origen" class="input">
                      <option value="Tanque">Tanque</option>
                      <option value="CamiÃ³n Service">CamiÃ³n Service</option>
                    </select>
                  </div>
                  <div class="field col-2">
                    <label>Observaciones</label>
                    <input id="cc-obs" class="input" placeholder="Notas u observaciones" />
                  </div>
                </div>

                <div class="card-actions">
                  <button id="btnGuardarCarga" class="btn success">ðŸ’¾ Guardar carga</button>
                  <span id="cc-msg" class="msg"></span>
                </div>
              </div>

              <!-- Tabla de cargas -->
              <div class="table-wrap">
                <table class="table" id="cc-tabla">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Interno</th>
                      <th>Chofer</th>
                      <th>Km</th>
                      <th>Litros</th>
                      <th>Tipo</th>
                      <th>Origen</th>
                      <th>Obs.</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <!-- Subtab: POR INTERNO -->
            <div id="subtab-interno" class="subtab-content hidden">
              <div class="filters-header">
                <h3>Consumo por Interno</h3>
                <div class="filters-buttons">
                  <button class="btn tiny filter-btn active" data-range="mes">Mes actual</button>
                  <button class="btn tiny filter-btn" data-range="semana">Ãšltima semana</button>
                  <button class="btn tiny filter-btn" data-range="total">Total</button>
                </div>
              </div>
              <div id="grid-interno" class="dashboard-grid"></div>
            </div>

            <!-- Subtab: POR CHOFER -->
            <div id="subtab-chofer" class="subtab-content hidden">
              <div class="filters-header">
                <h3>Consumo por Chofer</h3>
                <div class="filters-buttons">
                  <button class="btn tiny filter-btn active" data-range="mes">Mes actual</button>
                  <button class="btn tiny filter-btn" data-range="semana">Ãšltima semana</button>
                  <button class="btn tiny filter-btn" data-range="total">Total</button>
                </div>
              </div>
              <div id="grid-chofer" class="dashboard-grid"></div>
            </div>
          </div>
          <!-- ==================== FIN MÃ“DULO COMBUSTIBLE ==================== -->

          <!-- ====================== DASHBOARD ====================== -->
          <!-- ðŸ”¹ INICIA OCULTO (arranca NEUTRO) -->
          <div id="tab-dashboard" class="subtab hidden">
            <section class="metrics">
              <div class="metric-card">
                <p>Internos activos</p>
                <b id="mActivos">0</b>
              </div>
              <div class="metric-card">
                <p>PrÃ³ximos a service</p>
                <b id="mProx">0</b>
              </div>
              <div class="metric-card danger">
                <p>Equipos con service vencido</p>
                <b id="mVencidos">0</b>
              </div>
            </section>

            <h3 class="mt-16">Estado general de los internos</h3>
            <div id="dashboardCards" class="dashboard-grid"></div>
          </div>

          <!-- ====================== USUARIOS ====================== -->
          <div id="tab-usuarios" class="subtab hidden">
            <div class="card-header">
              <h3>Usuarios</h3>
              <div class="grid cols-3 gap-12">
                <input id="nu-nombre" class="input" placeholder="Nombre y apellido" />
                <input id="nu-legajo" class="input" placeholder="Legajo" />
                <select id="nu-rol" class="input">
                  <option value="operario">Operario</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <button id="btnAddUsuario" class="btn primary">Agregar usuario</button>
            </div>
            <div class="table-wrap">
              <table class="table">
                <thead><tr><th>Nombre</th><th>Legajo</th><th>Rol</th><th></th></tr></thead>
                <tbody id="tablaUsuarios"></tbody>
              </table>
            </div>
          </div>

          <!-- ====================== INTERNOS ====================== -->
          <div id="tab-internos" class="subtab hidden">
            <div class="card-header">
              <h3>Internos</h3>
              <div class="grid cols-6 gap-12">
                <input id="ni-codigo" class="input" placeholder="CÃ³digo" />
                <select id="ni-tipo" class="input">
                  <option value="horas">Horas</option>
                  <option value="km">Km</option>
                </select>
                <input id="ni-cada" class="input" placeholder="Cada (250 / 10000)" />
                <input id="ni-ultvalor" class="input" placeholder="Ãšlt. service valor" />
                <input id="ni-ultfecha" class="input" type="date" />
              </div>
              <button id="btnAddInterno" class="btn primary">Agregar interno</button>
            </div>
            <div class="table-wrap">
              <table class="table">
                <thead><tr><th>Interno</th><th>Tipo</th><th>Prox. cada</th><th>Ãšltimo service</th><th>Filtros</th><th>RM</th><th></th></tr></thead>
                <tbody id="tablaInternos"></tbody>
              </table>
            </div>
          </div>

          <!-- ====================== PARTES ====================== -->
          <div id="tab-partes" class="subtab hidden">
            <div class="table-wrap">
              <table class="table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Interno</th>
                    <th>Final</th>
                    <th>Combustible</th>
                    <th>Novedades</th>
                    <th>Estado</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tablaPartes"></tbody>
              </table>
            </div>

            <h4 class="mt-16">Ãšltimos 5</h4>
            <div class="table-wrap">
              <table class="table">
                <thead><tr><th>Fecha</th><th>Usuario</th><th>Interno</th><th>Final</th><th>Service</th></tr></thead>
                <tbody id="tablaUltimos"></tbody>
              </table>
            </div>
          </div>

          <!-- ====================== SERVICE ====================== -->
          <div id="tab-service" class="subtab hidden">
            <div class="card-header">
              <h3>Registrar Service</h3>
              <div class="grid cols-4 gap-12">
                <select id="sv-interno" class="input"></select>
                <input id="sv-fecha" type="date" class="input" />
                <input id="sv-valor" class="input" placeholder="Valor (km/hs)" />
                <input id="sv-rm" class="input" placeholder="RM (opcional)" />
              </div>
              <div class="grid cols-3 gap-12">
                <input id="sv-aceite-tipo" class="input" placeholder="Aceite tipo (opcional)" />
                <input id="sv-aceite-litros" class="input" placeholder="Litros" />
              </div>
              <div class="filters-grid">
                <div>
                  <div class="filters-header"><strong>Aceite</strong><button id="sv-add-aceite" class="btn tiny">+ Filtro</button></div>
                  <div id="sv-list-aceite" class="filters-list"></div>
                </div>
                <div>
                  <div class="filters-header"><strong>Aire Primario</strong><button id="sv-add-airep" class="btn tiny">+ Filtro</button></div>
                  <div id="sv-list-airep" class="filters-list"></div>
                </div>
                <div>
                  <div class="filters-header"><strong>Aire Secundario</strong><button id="sv-add-aires" class="btn tiny">+ Filtro</button></div>
                  <div id="sv-list-aires" class="filters-list"></div>
                </div>
                <div>
                  <div class="filters-header"><strong>Combustible</strong><button id="sv-add-comb" class="btn tiny">+ Filtro</button></div>
                  <div id="sv-list-comb" class="filters-list"></div>
                </div>
                <div>
                  <div class="filters-header"><strong>HabitÃ¡culo</strong><button id="sv-add-hab" class="btn tiny">+ Filtro</button></div>
                  <div id="sv-list-hab" class="filters-list"></div>
                </div>
                <div>
                  <div class="filters-header"><strong>HidrÃ¡ulico</strong><button id="sv-add-hid" class="btn tiny">+ Filtro</button></div>
                  <div id="sv-list-hid" class="filters-list"></div>
                </div>
              </div>
              <button id="btnAddService" class="btn success mt-12"><i class="fa-solid fa-screwdriver-wrench"></i> Guardar Service</button>
            </div>

            <div class="table-wrap mt-16">
              <table class="table">
                <thead><tr><th>Fecha</th><th>Interno</th><th>Valor</th><th>Tipo</th><th>Filtros</th><th>Aceite</th><th>RM/Notas</th></tr></thead>
                <tbody id="tablaService"></tbody>
              </table>
            </div>
          </div>

          <!-- ====================== SIN PARTES ====================== -->
          <div id="tab-sinpartes" class="subtab hidden">
            <div class="card">
              <h3>Internos sin partes recientes</h3>
              <ul id="listaSinPartes" class="chips"></ul>
              <h4 class="mt-16">Otros</h4>
              <ul id="listaSinPartes2" class="chips"></ul>
            </div>
          </div>

        </div>
      </section>
    </main>
  </div>

  <!-- Tu lÃ³gica principal -->
  <script type="module" src="script.js"></script>

  <!-- JS auxiliar mÃ­nimo (NO toca tu script.js) -->
  <script>
    (function () {
      // Asegurar que sidebar toggle opere siempre
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebarToggle');
      if (toggle) toggle.addEventListener('click', () => sidebar.classList.toggle('hidden'));

      // Al iniciar sesiÃ³n como admin/logÃ­stica, tu script.js llama a initAdmin().
      // Este bloque sÃ³lo garantiza: NEUTRO visible por defecto y navegaciÃ³n entre tabs.
      function showOnly(tabId) {
        // Ocultar todas las subtabs
        document.querySelectorAll('.subtab').forEach(t => t.classList.add('hidden'));
        // Quitar "active" de todos los botones
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        // Mostrar la requerida
        const el = document.getElementById('tab-' + tabId);
        if (el) el.classList.remove('hidden');
        // Activar botÃ³n correspondiente
        const btn = document.querySelector('.tab-btn[data-tab="' + tabId + '"]');
        if (btn) btn.classList.add('active');

        // Disparadores compatibles con tu script.js
        if (tabId === 'service' && typeof window.initServiceLists === 'function') {
          window.initServiceLists();
        }
        if (tabId === 'dashboard' && typeof window.renderDashboardMetrics === 'function') {
          window.renderDashboardMetrics();
        }
        if (tabId === 'combustible') {
          if (!window._combustibleIniciado && typeof window.initCombustible === 'function') {
            window.initCombustible().then(() => { window._combustibleIniciado = true; });
          }
        }
      }

      // Bind de botones laterales (una sola vez)
      document.querySelectorAll('.tab-btn').forEach(b => {
        b.addEventListener('click', () => showOnly(b.dataset.tab));
      });

      // Estado inicial NEUTRO (no activa ninguna tab hasta que el usuario elija)
      // Esto evita que se abra dashboard o combustible automÃ¡ticamente
      // y es consistente con el "neutro" que pediste.
      document.addEventListener('DOMContentLoaded', () => {
        // Ocultamos todas las subtabs y mostramos sÃ³lo el neutro
        document.querySelectorAll('.subtab').forEach(t => t.classList.add('hidden'));
        const neutral = document.getElementById('tab-neutral');
        if (neutral) neutral.classList.remove('hidden');

        // Asegurar que no haya botÃ³n marcado como activo
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      });
    })();
  </script>
</body>
</html>
